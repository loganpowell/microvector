name: Update Changelog

on:
  release:
    types: [published]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write # Needed to commit changelog updates
  models: read # Needed to access GitHub Models

jobs:
  update-changelog:
    name: Generate and Update Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git diff
          ref: main # Checkout main branch to get latest CHANGELOG.md

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --dev

      - name: Get previous release tag
        id: prev_release
        run: |
          # Source shared release range utilities
          source scripts/get_release_range.sh
          
          # Get commit range for this release
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          get_release_range "$CURRENT_TAG" "false"  # false = use tag as upper bound (not changelog commit)
          
          # Export outputs for next steps
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "lower_bound=$LOWER_BOUND" >> $GITHUB_OUTPUT
          echo "upper_bound=$UPPER_BOUND" >> $GITHUB_OUTPUT
          
          if [ "$LOWER_BOUND" = "$(git rev-list --max-parents=0 HEAD)" ]; then
            echo "first_release=true" >> $GITHUB_OUTPUT
          else
            echo "first_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate git diff
        id: git_diff
        run: |
          LOWER_BOUND="${{ steps.prev_release.outputs.lower_bound }}"
          UPPER_BOUND="${{ steps.prev_release.outputs.upper_bound }}"

          # Generate summary of changed files
          git diff --stat ${LOWER_BOUND}..${UPPER_BOUND} > diff_summary.txt

          # Get commit messages using shared utility
          source scripts/get_release_range.sh
          get_commits_with_hash "${LOWER_BOUND}" "${UPPER_BOUND}" "true" > commits.txt || echo "- No commits found" > commits.txt

          # Generate diff for functional code only (exclude config/docs)
          # Filter out: .md, .yml, .yaml, .sh, .json, .toml, .txt, .rst
          # --diff-filter=ACM: Only Added, Copied, Modified (excludes Deleted, Renamed)
          git diff --diff-filter=ACM ${LOWER_BOUND}..${UPPER_BOUND} -- \
            ':!*.md' ':!*.yml' ':!*.yaml' ':!*.json' \
            ':!*.toml' ':!*.txt' ':!*.rst' ':!*.cfg' ':!*.ini' \
            > functional_diff.txt

          echo "âœ… Git diff generated"
          echo "ðŸ“Š Changed files:"
          cat diff_summary.txt

      - name: Download benchmark results
        id: download_benchmarks
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: benchmark-results-python-*
          merge-multiple: true
          path: ./benchmark-data

      - name: Prepare benchmark summary
        id: benchmark_summary
        run: |
          # Use the script to prepare benchmark summary
          if uv run python scripts/prepare_benchmarks.py \
            --input ./benchmark-data \
            --output benchmark_summary.txt; then
            echo "has_benchmarks=true" >> $GITHUB_OUTPUT
          else
            echo "has_benchmarks=false" >> $GITHUB_OUTPUT
          fi

      - name: Install gh-models extension
        run: |
          gh extension install https://github.com/github/gh-models
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog entry with AI
        id: generate_changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          PREV_TAG="${{ steps.prev_release.outputs.prev_tag }}"
          IS_FIRST="${{ steps.prev_release.outputs.first_release }}"

          # Truncate functional diff using the script
          uv run python scripts/truncate_diff.py \
            functional_diff.txt \
            truncated_diff.txt \
            --max-tokens 3500

          # Create a concise context file for the AI
          cat > ai_context.txt << CONTEXT_EOF
          Release: ${CURRENT_TAG} (from ${PREV_TAG})

          Commits:
          $(cat commits.txt)

          Files Changed:
          $(cat diff_summary.txt | grep -E '\.(py|js|ts|jsx|tsx|c|cpp|h|go|rs|java)' | head -15)

          Code Changes:
          $(cat truncated_diff.txt)
          CONTEXT_EOF

          # Use GitHub Models to generate changelog entry
          if cat ai_context.txt | gh models run xai/grok-3 \
            "Based on commits and code changes, create a changelog for ${CURRENT_TAG}.

          Format:
          ## [${CURRENT_TAG}] - $(date +%Y-%m-%d)

          ### [Category]
          - User-facing description

          Use: Added, Changed, Fixed, Performance. Be concise." \
          > changelog_entry.md; then
            echo "âœ… Changelog entry generated"
            echo "ðŸ“ Preview:"
            cat changelog_entry.md
          else
            echo "âš ï¸ AI generation failed, creating basic changelog from commits"
            cat > changelog_entry.md << FALLBACK_EOF
          ## [${CURRENT_TAG}] - $(date +%Y-%m-%d)

          ### Changed

          $(cat commits.txt | sed 's/^- /- /' | sed 's/ ([a-f0-9]\{7\})$//')

          FALLBACK_EOF
            echo "ðŸ“ Fallback changelog:"
            cat changelog_entry.md
          fi

      - name: Update CHANGELOG.md
        run: |
          # Use the script to update CHANGELOG.md
          uv run python scripts/update_changelog.py \
            --changelog CHANGELOG.md \
            --entry changelog_entry.md \
            --version "${{ github.event.release.tag_name }}" \
            --repo "https://github.com/${{ github.repository }}"

          echo "ðŸ“„ Updated CHANGELOG.md:"
          head -n 50 CHANGELOG.md

      - name: Commit and push changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update CHANGELOG for ${{ github.event.release.tag_name }}"
            
            # Push to main branch (we're in detached HEAD state from the release tag)
            git push origin HEAD:main
            
            echo "âœ… Changelog committed and pushed"
          fi

      - name: Add changelog to release notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"

          # Create changelog link
          # Convert version to GitHub anchor format: v0.1.26 -> v0126---2025-10-23
          VERSION_ANCHOR=$(echo "$VERSION" | sed 's/\.//g')
          CHANGELOG_DATE=$(date +%Y-%m-%d)
          CHANGELOG_LINK="https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md#${VERSION_ANCHOR}---${CHANGELOG_DATE}"

          # Get current release notes
          CURRENT_NOTES=$(gh release view "${{ github.event.release.tag_name }}" --json body --jq '.body')

          # Create combined notes file with changelog link
          cat > combined_notes.md << EOF
          ${CURRENT_NOTES}

          ---

          ðŸ“ **[View Release Changelog](${CHANGELOG_LINK})**

          EOF

          # Update release with combined notes
          gh release edit "${{ github.event.release.tag_name }}" --notes-file combined_notes.md

          echo "âœ… Release notes updated with changelog link"
